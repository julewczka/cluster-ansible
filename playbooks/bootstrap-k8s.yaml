- name: setup nodes for K8s
  hosts: all
  become: yes
  tasks:
    - name: update & upgrade system
      ansible.builtin.import_tasks: update.yaml
    - name: install containerd
      ansible.builtin.import_tasks: install-containerd.yaml
    - name: install k8s components
      ansible.builtin.import_tasks: install-k8s-components.yaml

- name: configure k8s control plane
  hosts: k8sMasters
  become: yes
  tasks:
    - name: check if cluster is already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: admin_conf

    - name: init k8s cluster
      ansible.builtin.import_tasks: init-cluster.yaml
      when: not admin_conf.stat.exists

    - name: get join token
      ansible.builtin.import_tasks: get-join-token.yaml

- name: configure k8s workers
  hosts: k8sWorkers
  become: yes
  tasks:
    - name: join cluster
      ansible.builtin.import_tasks: join-cluster.yaml